# 调试指南

## 快速诊断问题

### 1. 打开浏览器开发者工具

按 `F12` 或右键点击页面选择"检查"

### 2. 查看控制台日志

切换到 **Console** 标签页，查看以下日志：

#### 题库授权相关
- `[toggleBankPermission]` - 题库选择/取消操作
- `[handleConfirmChanges]` - 变更检测和提交
- `[store.batchSetStudentPerms]` - 批量更新API调用
- `[AdminUserMgt useEffect]` - 状态同步

#### 考试相关
- `[exam]` - 考试相关操作
- `[practice]` - 练习相关操作

#### 权限相关
- `[perms]` - 权限更新操作
- `[batch-perms]` - 批量权限更新

### 3. 查看网络请求

切换到 **Network** 标签页：

1. 筛选 **XHR** 请求
2. 查找相关API请求
3. 检查 **Request Payload**（请求数据）
4. 检查 **Response**（响应数据）
5. 检查 **Status Code**（状态码）

### 4. 检查数据库

使用调试脚本检查实际数据：

```bash
# 检查学员题库授权
node scripts/check-bank-perms.cjs

# 检查题库列表
node scripts/check-banks.cjs
```

## 常见问题诊断

### 问题：题库授权显示不正确

**症状**：按钮显示"选择题库 (1)"，但实际授权为0

**诊断步骤**：
1. 打开控制台，查看 `[toggleBankPermission]` 日志
2. 确认题库ID是否正确
3. 点击"确认并应用修改"，查看 `[handleConfirmChanges]` 日志
4. 确认是否检测到变更
5. 查看 `[store.batchSetStudentPerms]` 日志
6. 确认API调用参数是否正确
7. 查看Network标签，检查 `POST /api/admin/students/batch-perms` 请求
8. 运行 `node scripts/check-bank-perms.cjs` 检查数据库

**可能原因**：
- 前端状态未正确更新
- API调用失败
- 数据库保存失败
- 数据格式错误

### 问题：API返回404

**症状**：网络请求返回404错误

**诊断步骤**：
1. 查看Network标签，找到失败的请求
2. 检查请求URL是否正确
3. 检查服务器是否正在运行
4. 检查端口是否正确（应为3001）
5. 查看服务器终端日志

**可能原因**：
- 服务器未启动
- 端口配置错误
- API路由未定义

### 问题：数据未保存

**症状**：应用修改后，刷新页面数据丢失

**诊断步骤**：
1. 查看控制台，确认API调用成功
2. 查看Network标签，确认响应为 `{ success: true }`
3. 运行数据库检查脚本
4. 检查服务器终端是否有错误

**可能原因**：
- API调用失败
- 数据库写入失败
- 数据格式错误
- 权限不足

## 调试技巧

### 1. 使用console.log

在代码中添加日志：
```typescript
console.log('[DEBUG] 变量名:', 变量值);
```

### 2. 使用debugger

在代码中添加断点：
```typescript
debugger; // 浏览器会在此处暂停
```

### 3. 使用React DevTools

安装React DevTools扩展，查看组件状态和props。

### 4. 使用Network面板

- 筛选请求类型（XHR, Fetch）
- 查看请求时序
- 检查请求头和响应头
- 复制请求为cURL命令

### 5. 使用Application面板

- 查看LocalStorage
- 查看SessionStorage
- 查看Cookies
- 清除缓存

## 性能分析

### 1. 使用Performance面板

记录页面加载和交互性能。

### 2. 使用Lighthouse

分析页面性能、可访问性、最佳实践。

### 3. 查看Bundle大小

```bash
npm run build
```

查看输出的文件大小。

## 服务器端调试

### 1. 查看服务器日志

服务器终端会显示所有请求和错误。

### 2. 添加服务器日志

在server.js中添加：
```javascript
console.log('[DEBUG] 变量名:', 变量值);
```

### 3. 使用SQLite命令行

```bash
sqlite3 edumaster.db
.tables
SELECT * FROM users LIMIT 5;
.quit
```

## 常用命令

```bash
# 启动开发服务器
npm run dev

# 启动后端服务器
node server.js

# 指定端口启动
$env:PORT=3001; node server.js

# 构建生产版本
npm run build

# 检查题库授权
node scripts/check-bank-perms.cjs

# 重置管理员密码
node scripts/reset-admin.cjs
```

## 获取帮助

1. 查看相关文档（docs/目录）
2. 检查控制台错误信息
3. 检查服务器日志
4. 运行调试脚本
5. 清除缓存重试

## 最佳实践

- ✅ 始终打开开发者工具
- ✅ 定期查看控制台日志
- ✅ 使用有意义的日志前缀
- ✅ 记录关键操作的输入输出
- ✅ 使用数据库检查脚本验证数据
- ✅ 保持代码整洁，便于调试
- ✅ 及时更新文档

---

**最后更新**：2026-01-07
