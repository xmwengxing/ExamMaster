# 智能复习功能优化说明

## 修改日期
2026-01-09

## 问题描述

### 问题1：退出按钮返回位置错误
**现象**：从错题本进入"启动今日智能复习"后，点击退出按钮返回到"练习"页面，而不是"错题本"页面。

**期望**：应该返回到"错题本"页面。

### 问题2："很难/重来"逻辑不合理
**现象**：在智能复习中点击"很难/重来"后，该题目从今日复习列表中消失了。

**期望**："很难/重来"应该保留题目在今日复习列表中，让用户可以继续练习。

## 解决方案

### 1. 修复退出按钮返回逻辑 ✅

**修改文件**：
- `pages/Student/PracticeMode.tsx`
- `App.tsx`

**实现逻辑**：

#### PracticeMode.tsx
```typescript
const handleExit = async () => {
  // ... 保存进度逻辑 ...
  
  if (isMockMode) {
    onFinish(calculateFinalScore(false));
  } else {
    // 如果是从错题本或智能复习模式退出，返回到错题本页面
    if (isMistakeMode || isSmartReviewMode) {
      onFinish({ returnToMistakes: true });  // ← 新增：传递返回标记
    } else {
      onFinish();
    }
  }
};
```

#### App.tsx
```typescript
onFinish={(result) => {
  if (isMock && result && typeof result.score === 'number') {
    // ... 模拟考试逻辑 ...
  } else if (result && result.returnToMistakes) {
    // 从错题本或智能复习退出，返回到错题本页面
    setActiveTab('mistakes');  // ← 新增：返回错题本
  } else if (isMistake) {
    setActiveTab('mistakes');
  } else {
    setActiveTab('practice');
  }
}}
```

**效果**：
- 从错题本进入智能复习 → 点击退出 → 返回错题本 ✅
- 从练习页面进入练习 → 点击退出 → 返回练习页面 ✅
- 从首页进入练习 → 点击退出 → 返回练习页面 ✅

---

### 2. 修复"很难/重来"逻辑 ✅

**修改文件**：
- `server.js`

**问题分析**：

原来的逻辑：
```javascript
if (level === 'HARD') {
  intervalDays = 1;  // ← 问题：设置为1天后，nextReviewDate 是明天
  repetitions = 0;
  easeFactor = Math.max(1.3, easeFactor - 0.2);
}
```

结果：
- `nextReviewDate` = 明天
- 题目不在今天的复习列表中（`nextReviewDate <= today` 为 false）
- 用户看不到这道题了

**修改后的逻辑**：

```javascript
if (level === 'HARD') {
  intervalDays = 0;  // ← 修复：设置为0天，nextReviewDate 是今天
  repetitions = 0;
  easeFactor = Math.max(1.3, easeFactor - 0.2);
}
```

结果：
- `nextReviewDate` = 今天
- 题目保持在今天的复习列表中（`nextReviewDate <= today` 为 true）
- 用户可以继续练习这道题 ✅

**SRS 算法说明**：

| 按钮 | 含义 | intervalDays | nextReviewDate | 是否保留在今日列表 |
|------|------|--------------|----------------|-------------------|
| 很难/重来 | 完全不会，需要重新学习 | 0 | 今天 | ✅ 是 |
| 已掌握 | 基本掌握，按标准间隔复习 | 1/6/递增 | 明天/6天后/更久 | ❌ 否 |
| 太简单了 | 完全掌握，加速复习间隔 | 更长 | 更久以后 | ❌ 否 |

---

## 用户体验改进

### 改进前

**场景1：退出按钮**
```
错题本 → 启动智能复习 → 做题 → 点击退出 → 练习页面 ❌
```
用户困惑：我明明是从错题本进来的，为什么退出到练习页面？

**场景2："很难/重来"**
```
智能复习 → 遇到难题 → 点击"很难/重来" → 题目消失 ❌
```
用户困惑：我点了"很难/重来"，为什么题目不见了？我还想继续练习！

### 改进后

**场景1：退出按钮**
```
错题本 → 启动智能复习 → 做题 → 点击退出 → 错题本 ✅
```
符合用户预期：从哪里来，回哪里去。

**场景2："很难/重来"**
```
智能复习 → 遇到难题 → 点击"很难/重来" → 题目保留 ✅
```
符合用户预期：标记为"很难"的题目应该继续出现，直到掌握为止。

---

## 技术细节

### SRS 记录结构

```typescript
interface SrsRecord {
  id: string;
  userId: string;
  questionId: string;
  interval: number;           // 复习间隔（天数）
  easeFactor: number;         // 难度系数
  repetitions: number;        // 重复次数
  nextReviewDate: string;     // 下次复习日期（YYYY-MM-DD）
  status: string;             // 状态（active/MASTERED）
}
```

### 复习列表筛选逻辑

```typescript
// 在 Mistakes.tsx 中
const reviewStats = useMemo(() => {
  const today = new Date().toISOString().split('T')[0];
  
  // 待复习：nextReviewDate <= today 的题目
  const pendingSrs = srsRecords
    .filter(r => r.nextReviewDate <= today)  // ← 关键判断
    .map(r => r.questionId);
  
  // 从未复习过的错题
  const neverReviewed = mistakes
    .filter(m => !reviewedIds.includes(m.id))
    .map(m => m.id);
  
  const allPendingIds = [...pendingSrs, ...neverReviewed];
  const pendingQuestions = mistakes.filter(m => allPendingIds.includes(m.id));
  
  return { pendingQuestions, pendingCount: pendingQuestions.length };
}, [mistakes, srsRecords, today]);
```

### 关键修改点

**修改前**：
```javascript
// "很难/重来"
intervalDays = 1;
nextReviewDate = new Date(now + 1天);  // 明天
// 结果：nextReviewDate > today，题目不在今日列表
```

**修改后**：
```javascript
// "很难/重来"
intervalDays = 0;
nextReviewDate = new Date(now + 0天);  // 今天
// 结果：nextReviewDate <= today，题目保留在今日列表 ✅
```

---

## 测试步骤

### 测试1：退出按钮返回位置

1. **登录学员账号**
2. **进入错题本**
   - 点击底部导航栏"错题"
3. **启动智能复习**
   - 点击"启动今日智能复习"按钮
4. **做几道题**
5. **点击退出按钮**（左上角）
6. **验证**：应该返回到错题本页面 ✅

### 测试2："很难/重来"保留题目

1. **登录学员账号**
2. **进入错题本**
3. **启动智能复习**
4. **遇到一道题**
5. **点击"很难/重来"按钮**
6. **继续做题**
7. **做完所有题目后退出**
8. **再次进入错题本**
9. **验证**：
   - "今日待巩固"数量应该包含刚才标记为"很难"的题目 ✅
   - 再次点击"启动今日智能复习"
   - 应该能看到刚才标记为"很难"的题目 ✅

### 测试3：其他按钮正常工作

1. **点击"已掌握"**
   - 题目应该从今日列表移除 ✅
   - 下次复习日期应该是明天或更久 ✅

2. **点击"太简单了"**
   - 题目应该从今日列表移除 ✅
   - 下次复习日期应该是更久以后 ✅

---

## 数据库变化

### SRS 记录示例

**点击"很难/重来"后**：
```json
{
  "id": "srs-1234567890",
  "userId": "student-001",
  "questionId": "q-001",
  "interval": 0,              // ← 0天
  "easeFactor": 2.3,
  "repetitions": 0,           // ← 重置为0
  "nextReviewDate": "2026-01-09",  // ← 今天
  "status": "active"
}
```

**点击"已掌握"后**：
```json
{
  "id": "srs-1234567890",
  "userId": "student-001",
  "questionId": "q-001",
  "interval": 1,              // ← 1天
  "easeFactor": 2.5,
  "repetitions": 1,           // ← 增加
  "nextReviewDate": "2026-01-10",  // ← 明天
  "status": "active"
}
```

---

## 相关文件

### 修改的文件

1. **server.js**
   - 修改 SRS 更新接口
   - 将"很难/重来"的 intervalDays 从 1 改为 0

2. **pages/Student/PracticeMode.tsx**
   - 修改 handleExit 函数
   - 添加返回错题本的逻辑

3. **App.tsx**
   - 修改 onFinish 处理
   - 根据返回标记决定跳转位置

### 未修改的文件

- `pages/Student/Mistakes.tsx` - 错题本页面（逻辑正确）
- `store.ts` - SRS 相关函数（逻辑正确）
- `types.ts` - 类型定义（无需修改）

---

## 部署说明

### 构建和部署

```bash
# 构建
npm run build

# 部署（Windows）
deploy-quick.bat

# 或使用 Linux/Mac
./deploy.sh
```

### 验证部署

1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 强制刷新页面（Ctrl+F5）
3. 按照测试步骤验证功能

---

## 常见问题

### Q1: 为什么"很难/重来"不是设置为明天复习？

**A:** 因为用户点击"很难/重来"表示这道题完全不会，需要立即重新学习。如果设置为明天，用户今天就看不到这道题了，无法继续练习。

### Q2: 如果用户一直点"很难/重来"，题目会一直出现吗？

**A:** 是的。这是正确的行为。用户应该反复练习直到掌握为止。当用户真正掌握后，可以点击"已掌握"或"太简单了"。

### Q3: "已掌握"和"太简单了"有什么区别？

**A:** 
- **已掌握**：按标准 SRS 间隔复习（1天 → 6天 → 递增）
- **太简单了**：加速复习间隔，更快地延长复习周期

### Q4: 退出按钮在其他模式下会受影响吗？

**A:** 不会。只有从错题本或智能复习模式退出时才会返回错题本，其他模式保持原有行为。

---

## 总结

### 修改内容

1. ✅ 修复退出按钮返回位置（错题本 → 智能复习 → 退出 → 错题本）
2. ✅ 修复"很难/重来"逻辑（保留题目在今日复习列表）

### 用户体验改进

- ✅ 退出按钮符合用户预期（从哪里来，回哪里去）
- ✅ "很难/重来"符合学习逻辑（继续练习直到掌握）
- ✅ SRS 算法更合理（难题保留，掌握的题目延后）

### 技术实现

- ✅ 代码修改简洁明了
- ✅ 不影响其他功能
- ✅ 向后兼容

---

**修改完成日期**：2026-01-09  
**版本**：v3.0（智能复习优化版）  
**状态**：✅ 已完成，待部署
