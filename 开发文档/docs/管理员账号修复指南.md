# EduMaster 管理员账号修复指南

## 问题描述
部署到VPS后，管理员账号无法登录，提示"账号或密码错误"。

## 可能的原因
1. 数据库文件未正确迁移
2. 密码哈希算法不一致
3. 管理员账号未创建
4. 数据库表结构变更导致账号数据丢失

## 解决方案

### 方案一：使用快速修复脚本（推荐）

#### Linux/Mac 系统
```bash
# 1. SSH 登录到 VPS
ssh user@your-vps-ip

# 2. 进入项目目录
cd /path/to/edumaster

# 3. 运行快速修复脚本
bash fix-admin-quick.sh
```

#### Windows 系统
```cmd
# 双击运行
fix-admin-quick.bat
```

### 方案二：手动检查和修复

#### 步骤1：检查管理员账号状态
```bash
node check-admin.js
```

这个脚本会：
- 列出所有管理员账号
- 显示账号详细信息
- 测试常用密码是否匹配

#### 步骤2：重置管理员密码
```bash
# 重置为默认密码 'admin'
node reset-admin-password.js

# 或指定新密码
node reset-admin-password.js your-new-password
```

### 方案三：直接创建管理员账号
如果数据库中没有管理员账号：
```bash
node create-admin.js
```

这会创建默认管理员：
- 账号: `admin`
- 密码: `admin`
- 角色: 超级管理员

## 验证修复

修复后，使用以下信息登录：
1. 打开浏览器访问系统
2. 选择"管理平台"
3. 输入账号和密码
4. 点击"立即登录"

## 常见问题

### Q1: 运行脚本时提示 "Cannot find module"
**解决方法：**
```bash
# 确保已安装依赖
npm install
```

### Q2: 数据库文件不存在
**解决方法：**
```bash
# 检查数据库文件位置
ls -la edumaster.db

# 如果不存在，需要初始化数据库
node server.js
# 然后 Ctrl+C 停止，再运行修复脚本
```

### Q3: 密码重置后仍无法登录
**可能原因：**
1. 浏览器缓存了旧的登录信息
   - 解决：清除浏览器缓存或使用无痕模式
2. 服务器未重启
   - 解决：重启 Node.js 服务
   ```bash
   pm2 restart edumaster
   # 或
   pm2 restart all
   ```

### Q4: 如何修改管理员账号名
管理员账号名固定为 `admin`，这是系统设计的超级管理员账号。
如需创建其他管理员，请：
1. 使用 `admin` 账号登录
2. 进入"权限"管理页面
3. 添加新的管理员账号

## 安全建议

1. **修改默认密码**
   - 首次登录后立即修改密码
   - 使用强密码（至少8位，包含字母、数字、特殊字符）

2. **定期备份数据库**
   ```bash
   # 备份数据库
   cp edumaster.db edumaster.db.backup.$(date +%Y%m%d)
   ```

3. **限制数据库文件权限**
   ```bash
   chmod 600 edumaster.db
   ```

## 技术细节

### 密码加密方式
系统使用 `bcryptjs` 进行密码加密：
- 加密轮数：10
- 算法：bcrypt
- 密码验证：`bcrypt.compareSync(plainPassword, hashedPassword)`

### 数据库表结构
管理员账号存储在 `users` 表：
```sql
SELECT * FROM users WHERE phone = 'admin' AND role = 'ADMIN';
```

关键字段：
- `phone`: 登录账号
- `password`: bcrypt 加密后的密码哈希
- `role`: 用户角色（ADMIN/STUDENT）

## 联系支持

如果以上方法都无法解决问题，请：
1. 检查服务器日志：`pm2 logs edumaster`
2. 查看数据库内容：`sqlite3 edumaster.db "SELECT * FROM users WHERE role='ADMIN';"`
3. 提供错误信息以便进一步诊断
