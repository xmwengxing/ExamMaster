# 填空题评分集成指南

## 概述

已在后端添加填空题评分API，前端可以调用此API来验证填空题答案并获取得分。

---

## 后端API

### 端点：`POST /api/questions/grade-fill-blank`

**功能**：验证填空题答案并计算得分

**请求头**：
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**：
```json
{
  "questionId": "q-1767861415925",
  "userAnswers": {
    "blank1": "脚本",
    "blank2": "web"
  }
}
```

**响应示例（全部正确）**：
```json
{
  "success": true,
  "correct": 2,
  "total": 2,
  "score": 100,
  "percentage": 100,
  "details": [
    {
      "blankId": "blank1",
      "userAnswer": "脚本",
      "isCorrect": true,
      "acceptedAnswers": ["脚本", "编程", "动态"]
    },
    {
      "blankId": "blank2",
      "userAnswer": "web",
      "isCorrect": true,
      "acceptedAnswers": ["Web", "网页", "前端"]
    }
  ],
  "isAllCorrect": true
}
```

**响应示例（部分正确）**：
```json
{
  "success": true,
  "correct": 1,
  "total": 2,
  "score": 50,
  "percentage": 50,
  "details": [
    {
      "blankId": "blank1",
      "userAnswer": "脚本",
      "isCorrect": true,
      "acceptedAnswers": ["脚本", "编程", "动态"]
    },
    {
      "blankId": "blank2",
      "userAnswer": "后端",
      "isCorrect": false,
      "acceptedAnswers": ["Web", "网页", "前端"]
    }
  ],
  "isAllCorrect": false
}
```

**错误响应**：
```json
{
  "error": "题目不存在"
}
```

---

## 前端集成步骤

### 1. 在 `store.ts` 中添加评分方法

```typescript
// 在 useAppStore 中添加
gradeFillInBlank: async (questionId: string, userAnswers: Record<string, string>) => {
  const token = localStorage.getItem('edu_token');
  if (!token) throw new Error('未登录');
  
  const response = await fetch(`${API_BASE}/questions/grade-fill-blank`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ questionId, userAnswers })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || '评分失败');
  }
  
  return await response.json();
}
```

### 2. 在 `PracticeMode.tsx` 中集成填空题评分

#### 2.1 添加填空题答案状态

```typescript
// 在组件状态中添加
const [fillBlankAnswers, setFillBlankAnswers] = useState<Record<string, string>>({});
const [fillBlankResult, setFillBlankResult] = useState<any>(null);
```

#### 2.2 创建填空题输入组件

```typescript
// 渲染填空题输入框
const renderFillInBlankQuestion = () => {
  if (currentQuestion.type !== QuestionType.FILL_IN_BLANK) return null;
  
  const blanks = currentQuestion.blanks || [];
  
  return (
    <div className="space-y-4">
      {blanks.map((blank: any) => (
        <div key={blank.id} className="flex items-center gap-3">
          <label className="text-sm font-bold text-gray-700 min-w-[80px]">
            空白 {blank.position}:
          </label>
          <input
            type="text"
            value={fillBlankAnswers[blank.id] || ''}
            onChange={(e) => setFillBlankAnswers({
              ...fillBlankAnswers,
              [blank.id]: e.target.value
            })}
            disabled={isAnswered && !isMockMode}
            className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            placeholder="请输入答案"
          />
          {isAnswered && fillBlankResult && (
            <span className={`text-sm font-bold ${
              fillBlankResult.details.find((d: any) => d.blankId === blank.id)?.isCorrect
                ? 'text-emerald-600'
                : 'text-rose-600'
            }`}>
              {fillBlankResult.details.find((d: any) => d.blankId === blank.id)?.isCorrect ? '✓' : '✗'}
            </span>
          )}
        </div>
      ))}
      
      {!isAnswered && (
        <button
          onClick={handleSubmitFillBlank}
          className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700"
        >
          提交答案
        </button>
      )}
      
      {isAnswered && fillBlankResult && (
        <div className={`p-4 rounded-lg ${
          fillBlankResult.isAllCorrect ? 'bg-emerald-50' : 'bg-rose-50'
        }`}>
          <div className="text-sm font-bold mb-2">
            得分：{fillBlankResult.score}/100 ({fillBlankResult.percentage}%)
          </div>
          <div className="text-sm">
            正确：{fillBlankResult.correct}/{fillBlankResult.total}
          </div>
        </div>
      )}
    </div>
  );
};
```

#### 2.3 添加提交处理函数

```typescript
const handleSubmitFillBlank = async () => {
  if (!currentQuestion || currentQuestion.type !== QuestionType.FILL_IN_BLANK) return;
  
  try {
    // 调用评分API
    const result = await store.gradeFillInBlank(currentQuestion.id, fillBlankAnswers);
    
    setFillBlankResult(result);
    setIsAnswered(true);
    setShowExplanation(true);
    
    // 保存用户答案
    const newAnswers = {
      ...userAnswers,
      [currentQuestion.id]: Object.values(fillBlankAnswers)
    };
    setUserAnswers(newAnswers);
    
    // 统计答对/答错
    if (result.isAllCorrect) {
      onCorrect(currentQuestion);
      provideFeedback(true);
    } else {
      onWrong(currentQuestion);
      provideFeedback(false);
    }
    
    // 保存进度
    await saveProgressImmediately(currentIndex, newAnswers);
    
  } catch (error) {
    console.error('[填空题评分失败]', error);
    alert('评分失败：' + error.message);
  }
};
```

#### 2.4 在题目渲染中添加填空题支持

```typescript
// 在渲染题目内容的地方添加
{currentQuestion.type === QuestionType.FILL_IN_BLANK && renderFillInBlankQuestion()}
```

### 3. 在 `types.ts` 中添加类型定义

```typescript
// 如果还没有，添加填空题类型
export enum QuestionType {
  SINGLE = 'SINGLE',
  MULTIPLE = 'MULTIPLE',
  JUDGE = 'JUDGE',
  FILL_IN_BLANK = 'FILL_IN_BLANK',
  SHORT_ANSWER = 'SHORT_ANSWER'
}

// 添加填空题配置接口
export interface BlankConfig {
  id: string;
  position: number;
  acceptedAnswers: string[];
  caseSensitive?: boolean;
}

// 扩展 Question 接口
export interface Question {
  // ... 现有字段
  blanks?: BlankConfig[];
  referenceAnswer?: string;
  aiGradingEnabled?: boolean;
  tags?: string[];
}
```

---

## 考试模式集成

### 在考试提交时计算填空题得分

```typescript
// 在考试提交逻辑中
const calculateExamScore = async (questions: Question[], userAnswers: Record<string, string[]>) => {
  let totalScore = 0;
  const wrongQuestionIds: string[] = [];
  
  for (const question of questions) {
    const questionScore = getQuestionScore(question); // 获取题目分值
    
    if (question.type === QuestionType.FILL_IN_BLANK) {
      // 调用填空题评分API
      try {
        const fillBlankAnswers: Record<string, string> = {};
        const userAnswerArray = userAnswers[question.id] || [];
        
        // 将数组答案转换为对象格式
        question.blanks?.forEach((blank, index) => {
          fillBlankAnswers[blank.id] = userAnswerArray[index] || '';
        });
        
        const result = await store.gradeFillInBlank(question.id, fillBlankAnswers);
        
        // 按比例计算得分
        totalScore += (result.score / 100) * questionScore;
        
        // 如果不是全对，加入错题
        if (!result.isAllCorrect) {
          wrongQuestionIds.push(question.id);
        }
      } catch (error) {
        console.error('[填空题评分失败]', error);
        // 评分失败时不给分
        wrongQuestionIds.push(question.id);
      }
    } else {
      // 其他题型的评分逻辑
      const isCorrect = checkAnswer(question, userAnswers[question.id]);
      if (isCorrect) {
        totalScore += questionScore;
      } else {
        wrongQuestionIds.push(question.id);
      }
    }
  }
  
  return { totalScore, wrongQuestionIds };
};
```

---

## 测试验证

### 测试用例

1. **全部正确**
   - 输入：{blank1: '脚本', blank2: 'web'}
   - 预期：score=100, correct=2/2

2. **部分正确**
   - 输入：{blank1: '脚本', blank2: '后端'}
   - 预期：score=50, correct=1/2

3. **全部错误**
   - 输入：{blank1: '错误', blank2: '错误'}
   - 预期：score=0, correct=0/2

4. **大小写不敏感**
   - 输入：{blank1: '脚本', blank2: 'WEB'}
   - 预期：score=100, correct=2/2

5. **空格处理**
   - 输入：{blank1: '  脚本  ', blank2: ' web '}
   - 预期：score=100, correct=2/2

---

## 注意事项

1. **答案格式**
   - 用户答案以对象形式提交：`{blankId: answer}`
   - 后端会自动处理大小写和空格

2. **错误处理**
   - 题目不存在：返回404
   - 题目类型错误：返回400
   - 配置无效：返回500

3. **性能考虑**
   - 评分在后端进行，避免前端逻辑复杂化
   - 支持批量评分（如果需要，可以扩展API）

4. **用户体验**
   - 提供即时反馈（每个空白显示对错）
   - 显示得分和百分比
   - 显示可接受的答案列表

---

## 下一步

1. ✅ 后端API已实现并测试通过
2. ⏳ 前端组件开发（任务11）
3. ⏳ 考试模式集成
4. ⏳ 练习模式集成
5. ⏳ 简答题AI评分集成（任务12）

---

## 相关文件

- `server.js` - 后端API实现（第1920行）
- `utils/questionValidation.js` - 填空题验证函数
- `pages/Student/PracticeMode.tsx` - 练习模式组件
- `pages/Student/Exams.tsx` - 考试模式组件
- `store.ts` - 状态管理
- `types.ts` - 类型定义

---

## 测试结果

✅ API测试通过
- 全部正确：100分
- 部分正确：50分（1/2）
- 大小写不敏感：正常工作
- 空格处理：正常工作

服务器已启动，可以开始前端集成开发。
